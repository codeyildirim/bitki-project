import React, { useState, useEffect } from 'react';
import { Upload, Trash2, Eye, Image, Film, Monitor, Smartphone } from 'lucide-react';
import toast from 'react-hot-toast';

const BackgroundSettings = () => {
  const [activeTab, setActiveTab] = useState('home');
  const [backgrounds, setBackgrounds] = useState({});
  const [uploading, setUploading] = useState(false);
  const [loading, setLoading] = useState(true);

  const pages = [
    { key: 'home', label: 'Ana Sayfa', icon: 'üè†' },
    { key: 'products', label: '√úr√ºnler', icon: 'üì¶' },
    { key: 'blog', label: 'Blog', icon: 'üìù' }
  ];

  // Mevcut arka planlarƒ± getir
  const fetchBackgrounds = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(createApiUrl('/api/admin/background/list'), {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        setBackgrounds(data.data);
      } else {
        toast.error('Arka planlar y√ºklenemedi');
      }
    } catch (error) {
      console.error('Arka plan listesi hatasƒ±:', error);
      toast.error('Baƒülantƒ± hatasƒ±');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchBackgrounds();
  }, []);

  // Dosya y√ºkleme
  const handleUpload = async (page, type, format, file) => {
    if (!file) {
      toast.error('Dosya se√ßilmedi');
      return;
    }

    console.log('Upload ba≈ülatƒ±lƒ±yor:', { page, type, format, file: file.name });

    // Dosya boyutu kontrol√º
    const maxSize = type === 'mobile' ? 10 * 1024 * 1024 : 50 * 1024 * 1024;
    if (file.size > maxSize) {
      toast.error(`Dosya √ßok b√ºy√ºk. Maksimum: ${type === 'mobile' ? '10MB' : '50MB'}`);
      return;
    }

    // Format kontrol√º
    if (format === 'video' && !file.type.includes('mp4') && !file.name.toLowerCase().endsWith('.mp4')) {
      toast.error('Video dosyasƒ± MP4 formatƒ±nda olmalƒ±dƒ±r');
      return;
    }

    if (format === 'image' && !file.type.startsWith('image/')) {
      toast.error('Resim dosyasƒ± JPG, PNG veya WebP formatƒ±nda olmalƒ±dƒ±r');
      return;
    }

    setUploading(true);

    try {
      // FormData olu≈ütur
      const formData = new FormData();
      formData.append('file', file);
      formData.append('page', page);
      formData.append('type', type);
      formData.append('format', format);

      console.log('FormData hazƒ±rlandƒ±:', {
        page,
        type,
        format,
        fileName: file.name,
        fileSize: file.size,
        fileType: file.type
      });

      const token = localStorage.getItem('token');

      const response = await fetch(createApiUrl('/api/admin/background/upload'), {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
          // Content-Type header'ƒ±nƒ± EKLEME - FormData otomatik olarak ekler
        },
        body: formData
      });

      console.log('Response status:', response.status);

      const data = await response.json();
      console.log('Response data:', data);

      if (response.ok) {
        toast.success(data.message || 'Arka plan ba≈üarƒ±yla y√ºklendi');
        // Cache-bust i√ßin yeniden y√ºkle
        await fetchBackgrounds();
        // Bildirim g√∂sterdikten sonra yenile
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        toast.error(data.message || `Upload ba≈üarƒ±sƒ±z (${response.status})`);
      }
    } catch (error) {
      console.error('Upload hatasƒ±:', error);
      toast.error('Y√ºkleme sƒ±rasƒ±nda baƒülantƒ± hatasƒ± olu≈ütu');
    } finally {
      setUploading(false);
    }
  };

  // Dosya silme
  const handleDelete = async (page, type, format) => {
    if (!window.confirm('Bu arka planƒ± silmek istediƒüinize emin misiniz?')) {
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(createApiUrl('/api/admin/background/delete'), {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ page, type, format })
      });

      const data = await response.json();

      if (response.ok) {
        toast.success('Arka plan silindi');
        await fetchBackgrounds();
      } else {
        toast.error(data.message || 'Silme ba≈üarƒ±sƒ±z');
      }
    } catch (error) {
      console.error('Delete hatasƒ±:', error);
      toast.error('Silme sƒ±rasƒ±nda hata olu≈ütu');
    }
  };

  // Dosya boyutunu formatla
  const formatFileSize = (bytes) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  };

  // √ñnizleme URL'i olu≈ütur
  const getPreviewUrl = (path) => {
    return path ? `${path}?v=${Date.now()}` : null;
  };

  // Tek cihaz i√ßin upload/preview bile≈üeni
  const DeviceUploader = ({ page, deviceType, deviceIcon, deviceLabel }) => {
    const deviceData = backgrounds[page]?.[deviceType] || {};
    const hasVideo = deviceData.video;
    const hasImage = deviceData.image;

    return (
      <div className="bg-gray-800 rounded-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            {deviceIcon}
            <h4 className="text-lg font-semibold text-white">{deviceLabel}</h4>
          </div>
        </div>

        {/* Video Y√ºkleme */}
        <div className="mb-4">
          <div className="flex items-center justify-between mb-2">
            <label className="text-sm text-gray-400 flex items-center gap-1">
              <Film size={16} />
              Video (MP4)
            </label>
            {hasVideo && (
              <button
                onClick={() => handleDelete(page, deviceType, 'video')}
                className="text-red-400 hover:text-red-300"
              >
                <Trash2 size={16} />
              </button>
            )}
          </div>

          {hasVideo ? (
            <div className="bg-gray-700 rounded p-3">
              <div className="flex items-center justify-between">
                <div className="text-xs text-gray-400">
                  <p>{hasVideo.filename}</p>
                  <p>{formatFileSize(hasVideo.size)}</p>
                </div>
                <a
                  href={getPreviewUrl(hasVideo.path)}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-400 hover:text-blue-300"
                >
                  <Eye size={16} />
                </a>
              </div>
            </div>
          ) : (
            <label className="block cursor-pointer">
              <input
                type="file"
                accept="video/mp4"
                className="hidden"
                onChange={(e) => handleUpload(page, deviceType, 'video', e.target.files[0])}
                disabled={uploading}
              />
              <div className="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-gray-500 transition-colors">
                <Upload size={20} className="mx-auto mb-2 text-gray-500" />
                <p className="text-sm text-gray-500">Video y√ºkle</p>
                <p className="text-xs text-gray-600 mt-1">Maks: {deviceType === 'mobile' ? '10MB' : '50MB'}</p>
              </div>
            </label>
          )}
        </div>

        {/* Resim Y√ºkleme */}
        <div>
          <div className="flex items-center justify-between mb-2">
            <label className="text-sm text-gray-400 flex items-center gap-1">
              <Image size={16} />
              Resim (JPG/PNG/WebP)
            </label>
            {hasImage && (
              <button
                onClick={() => handleDelete(page, deviceType, 'image')}
                className="text-red-400 hover:text-red-300"
              >
                <Trash2 size={16} />
              </button>
            )}
          </div>

          {hasImage ? (
            <div className="bg-gray-700 rounded p-3">
              <div className="flex items-center justify-between">
                <div className="text-xs text-gray-400">
                  <p>{hasImage.filename}</p>
                  <p>{formatFileSize(hasImage.size)}</p>
                </div>
                <a
                  href={getPreviewUrl(hasImage.path)}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-400 hover:text-blue-300"
                >
                  <Eye size={16} />
                </a>
              </div>
            </div>
          ) : (
            <label className="block cursor-pointer">
              <input
                type="file"
                accept="image/jpeg,image/jpg,image/png,image/webp"
                className="hidden"
                onChange={(e) => handleUpload(page, deviceType, 'image', e.target.files[0])}
                disabled={uploading}
              />
              <div className="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-gray-500 transition-colors">
                <Upload size={20} className="mx-auto mb-2 text-gray-500" />
                <p className="text-sm text-gray-500">Resim y√ºkle</p>
                <p className="text-xs text-gray-600 mt-1">Maks: {deviceType === 'mobile' ? '10MB' : '50MB'}</p>
              </div>
            </label>
          )}
        </div>
      </div>
    );
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-gray-400">Y√ºkleniyor...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Ba≈ülƒ±k */}
      <div>
        <h2 className="text-2xl font-bold text-white mb-2">Arka Plan Y√∂netimi</h2>
        <p className="text-gray-400">Sayfalara √∂zel video ve resim arka planlarƒ± y√ºkleyin</p>
      </div>

      {/* Sekme Se√ßici */}
      <div className="flex gap-2 border-b border-gray-700">
        {pages.map(page => (
          <button
            key={page.key}
            onClick={() => setActiveTab(page.key)}
            className={`px-4 py-2 font-medium transition-colors ${
              activeTab === page.key
                ? 'text-blue-400 border-b-2 border-blue-400'
                : 'text-gray-400 hover:text-gray-300'
            }`}
          >
            <span className="mr-2">{page.icon}</span>
            {page.label}
          </button>
        ))}
      </div>

      {/* ƒ∞√ßerik */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Mobil */}
        <DeviceUploader
          page={activeTab}
          deviceType="mobile"
          deviceIcon={<Smartphone size={20} className="text-gray-400" />}
          deviceLabel="Mobil"
        />

        {/* Desktop */}
        <DeviceUploader
          page={activeTab}
          deviceType="desktop"
          deviceIcon={<Monitor size={20} className="text-gray-400" />}
          deviceLabel="Masa√ºst√º"
        />
      </div>

      {/* Bilgi */}
      <div className="bg-blue-900 bg-opacity-50 rounded-lg p-4 border border-blue-700">
        <h4 className="text-blue-400 font-semibold mb-2">üìå √ñnemli Notlar</h4>
        <ul className="text-sm text-gray-300 space-y-1">
          <li>‚Ä¢ Video formatƒ± sadece MP4 olmalƒ±dƒ±r</li>
          <li>‚Ä¢ Resim formatlarƒ±: JPG, PNG, WebP</li>
          <li>‚Ä¢ Mobil i√ßin maksimum dosya boyutu: 10MB</li>
          <li>‚Ä¢ Desktop i√ßin maksimum dosya boyutu: 50MB</li>
          <li>‚Ä¢ Video yoksa otomatik olarak resim g√∂sterilir</li>
          <li>‚Ä¢ Her ikisi de yoksa sayfa ≈üeffaf kalƒ±r</li>
          <li>‚Ä¢ Safari'de autoplay i√ßin videolar sessize alƒ±nmƒ±≈ütƒ±r</li>
        </ul>
      </div>

      {uploading && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-gray-800 rounded-lg p-6 flex items-center gap-4">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"></div>
            <span className="text-white">Y√ºkleniyor...</span>
          </div>
        </div>
      )}
    </div>
  );
};

export default BackgroundSettings;